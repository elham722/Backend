@model dynamic
@{
    ViewData["Title"] = "مدیریت کاربران";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>
        <i class="fas fa-users me-2"></i>
        مدیریت کاربران
    </h4>
    <a href="@Url.Action("Create", "Users", new { area = "Admin" })" class="btn btn-admin">
        <i class="fas fa-plus me-1"></i>
        کاربر جدید
    </a>
</div>

<!-- Search and Filter -->
<div class="admin-card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-6">
                <label for="searchTerm" class="form-label">جستجو</label>
                <input type="text" class="form-control" id="searchTerm" name="searchTerm" 
                       value="@Model.SearchTerm" placeholder="جستجو بر اساس نام کاربری یا ایمیل...">
            </div>
            <div class="col-md-3">
                <label for="pageSize" class="form-label">تعداد در صفحه</label>
                <select class="form-select" id="pageSize" name="pageSize">
                    <option value="10" selected="@(Model.PageSize == 10 ? "selected" : null)">10</option>
                    <option value="25" selected="@(Model.PageSize == 25 ? "selected" : null)">25</option>
                    <option value="50" selected="@(Model.PageSize == 50 ? "selected" : null)">50</option>
                    <option value="100" selected="@(Model.PageSize == 100 ? "selected" : null)">100</option>

                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-admin me-2">
                    <i class="fas fa-search me-1"></i>
                    جستجو
                </button>
                <a href="@Url.Action("Index", "Users", new { area = "Admin" })" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>
                    پاک کردن
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Users Table -->
<div class="admin-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            لیست کاربران
            @if (Model.Users.TotalCount > 0)
            {
                <span class="badge bg-primary ms-2">@Model.Users.TotalCount کاربر</span>
            }
        </h5>
    </div>
    <div class="card-body">
        @if (Model.Users.Items.Any())
        {
            <div class="table-responsive">
                <table class="table table-admin">
                    <thead>
                        <tr>
                            <th>نام کاربری</th>
                            <th>ایمیل</th>
                            <th>نقش‌ها</th>
                            <th>وضعیت</th>
                            <th>تاریخ عضویت</th>
                            <th>آخرین ورود</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in Model.Users.Items)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                            @user.UserName.Substring(0, 1).ToUpper()
                                        </div>
                                        <div>
                                            <div class="fw-bold">@user.UserName</div>
                                            @if (user.PhoneNumber != null)
                                            {
                                                <small class="text-muted">@user.PhoneNumber</small>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>@user.Email</div>
                                    @if (user.IsEmailConfirmed)
                                    {
                                        <small class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            تایید شده
                                        </small>
                                    }
                                    else
                                    {
                                        <small class="text-warning">
                                            <i class="fas fa-exclamation-circle me-1"></i>
                                            تایید نشده
                                        </small>
                                    }
                                </td>
                                <td>
                                    @foreach (var role in user.Roles.Take(2))
                                    {
                                        <span class="badge bg-info me-1">@role</span>
                                    }
                                    @if (user.Roles.Count > 2)
                                    {
                                        <span class="badge bg-secondary">+@(user.Roles.Count - 2)</span>
                                    }
                                </td>
                                <td>
                                    @if (user.IsActive)
                                    {
                                        <span class="badge bg-success">فعال</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">غیرفعال</span>
                                    }
                                </td>
                                <td>
                                    <small class="text-muted">@user.CreatedAt.ToString("yyyy/MM/dd")</small>
                                </td>
                                <td>
                                    @if (user.LastLoginAt.HasValue)
                                    {
                                        <small class="text-muted">@user.LastLoginAt.Value.ToString("yyyy/MM/dd HH:mm")</small>
                                    }
                                    else
                                    {
                                        <small class="text-muted">هرگز</small>
                                    }
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="@Url.Action("Details", "Users", new { area = "Admin", id = user.Id })" 
                                           class="btn btn-sm btn-outline-primary" title="مشاهده">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="@Url.Action("Edit", "Users", new { area = "Admin", id = user.Id })" 
                                           class="btn btn-sm btn-outline-warning" title="ویرایش">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        @if (ViewData["IsSuperAdmin"] as bool? == true && user.Id != ViewData["AdminId"]?.ToString())
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="confirmDelete('@user.Id', '@user.UserName')" title="حذف">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            @if (Model.Users.TotalPages > 1)
            {
                <nav aria-label="صفحه‌بندی کاربران" class="mt-4">
                    <ul class="pagination justify-content-center">
                        @if (Model.Users.HasPreviousPage)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", "Users", new { 
                                    area = "Admin", 
                                    page = Model.Users.PageNumber - 1, 
                                    pageSize = Model.PageSize, 
                                    searchTerm = Model.SearchTerm 
                                })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        }

                        @for (int i = Math.Max(1, Model.Users.PageNumber - 2); i <= Math.Min(Model.Users.TotalPages, Model.Users.PageNumber + 2); i++)
                        {
                            <li class="page-item @(i == Model.Users.PageNumber ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", "Users", new { 
                                    area = "Admin", 
                                    page = i, 
                                    pageSize = Model.PageSize, 
                                    searchTerm = Model.SearchTerm 
                                })">@i</a>
                            </li>
                        }

                        @if (Model.Users.HasNextPage)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", "Users", new { 
                                    area = "Admin", 
                                    page = Model.Users.PageNumber + 1, 
                                    pageSize = Model.PageSize, 
                                    searchTerm = Model.SearchTerm 
                                })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        }
        else
        {
            <div class="text-center text-muted py-5">
                <i class="fas fa-users fa-4x mb-3"></i>
                <h5>هیچ کاربری یافت نشد</h5>
                <p>@(string.IsNullOrEmpty(Model.SearchTerm) ? "هنوز کاربری ثبت نشده است." : "با معیارهای جستجوی شما هیچ کاربری یافت نشد.")</p>
                @if (string.IsNullOrEmpty(Model.SearchTerm))
                {
                    <a href="@Url.Action("Create", "Users", new { area = "Admin" })" class="btn btn-admin">
                        <i class="fas fa-plus me-1"></i>
                        اولین کاربر را ایجاد کنید
                    </a>
                }
            </div>
        }
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">تایید حذف کاربر</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>آیا از حذف کاربر <strong id="userNameToDelete"></strong> اطمینان دارید؟</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    این عمل قابل بازگشت نیست!
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <form method="post" id="deleteForm" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        حذف
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function confirmDelete(userId, userName) {
            document.getElementById('userNameToDelete').textContent = userName;
            document.getElementById('deleteForm').action = '@Url.Action("Delete", "Users", new { area = "Admin" })/' + userId;
            
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        // Auto-submit form on page size change
        document.getElementById('pageSize').addEventListener('change', function() {
            this.form.submit();
        });
    </script>
}